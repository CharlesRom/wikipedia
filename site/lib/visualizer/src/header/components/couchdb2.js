define(["jquery","src/util/ui","src/header/components/default","src/util/versioning","forms/button","src/util/util","lib/webtoolkit/base64","forms/form","lib/couchdb/jquery.couch","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/autocomplete"],function(a,b,c,d,e,f,g,h){function i(){}function j(b,c){for(var d={},e=0;e<b.length;e++){var f=b[e],g=k(f);a.extend(!0,d,g)}return l(d,"",c)}function k(a){for(var b=a.value.flavors,c={},d=c,e=0;e<b.length-1;e++)d=d[b[e]]={__folder:!0};return d[b[b.length-1]]={__name:b.join(":"),__doc:a.doc,__data:a.value.data,__view:a.value.view,__meta:a.value.meta,__public:a.value.isPublic},c}function l(a,b,c){var d,e;b.length?d=e=[]:(e=[{key:c,title:c,folder:!0,children:[]}],d=e[0].children,b=c+":");for(var f in a)if(0!==f.indexOf("__")){var g=a[f],h=b+f,i={title:f,key:h};g.__folder?(g.__name&&d.push({doc:g.__doc,hasData:g.__data,hasView:g.__view,hasMeta:g.__meta,isPublic:g.__public,lazy:!0,title:f,key:h}),i.folder=!0,i.children=l(g,h+":",c)):(i.lazy=!0,i.doc=g.__doc,i.hasData=g.__data,i.hasView=g.__view,i.hasMeta=g.__meta,i.isPublic=g.__public),d.push(i)}return e}function m(a,b){for(var c=a.join(":"),d=0,e=b.length;e>d;d++){var f=b[d].value.flavors.join(":");if(c===f)return!0}return!1}var n=/^[a-zA-Z0-9]+$/;return f.inherits(i,c,{initImpl:function(){this.ok=this.loggedIn=!1,this.id=f.getNextUniqueId(),this.options.loginMethods=this.options.loginMethods||["couchdb"],this.options.url&&(a.couch.urlPrefix=this.options.url.replace(/\/$/,"")),this.url=a.couch.urlPrefix;var b=this.options.database||"visualizer";this.database=a.couch.db(b),a.ui.fancytree.debugLevel=0,this.checkDatabase()},showError:function(a,b){var c,d="red";if(2===b&&(d="green"),"number"==typeof a)switch(a){case 10:c="Colons are not allowed in the name.";break;case 11:c="Please select a folder";break;case 12:c="A folder with this name already exists.";break;case 20:c="Document already has this flavor";break;case 21:c="Path already used by another document";break;case 401:c="Wrong username or password.";break;case 409:c="Conflict. An entry with the same name already exists.";break;case 503:c="Service Unavailable.";break;default:c="Unknown error."}else c=a;this.errorP.text(c).css("color",d).show().delay(3e3).fadeOut()},getFormContent:function(b){return a("#"+this.cssId(b)).val().trim()},setFormContent:function(b,c){a("#"+this.cssId(b)).val(c)},checkDatabase:function(){var b=this;a.couch.info({success:function(a){b.ok=!0},error:function(a,b,c){console.error("CouchDB header : database connection error. Code:"+a+".",c)}})},cssId:function(a){return"ci-couchdb-header-"+this.id+"-"+a},changeFlavor:function(a){return n.test(a)?(this.flavor=a,this.setFormContent("flavor-input",a),void this.loadFlavor()):this.showError("Flavor name must be alphanumeric.")},_onClick:function(){this.ok?(this.setStyleOpen(this._open),this._open?(this.createMenu(),this.errorP.hide(),this.open()):this.close()):(this.checkDatabase(),console.error("CouchDB header : unreachable database."))},createMenu:function(){if(this.$_elToOpen)return void this.openMenu(this.loggedIn?"tree":"login");var b=this;this.$_elToOpen=a("<div>").css("width",560),this.errorP=a('<p id="'+this.cssId("error")+'">'),a.couch.session({success:function(a){null===a.userCtx.name?b.openMenu("login"):(b.loggedIn=!0,b.username=a.userCtx.name,b.openMenu("tree"))}})},openMenu:function(a){a!==this.lastMenu&&("tree"===a?(this.$_elToOpen.html(this.getMenuContent()),this.lastMenu="tree"):"login"===a&&(this.$_elToOpen.html(this.getLoginForm()),this.lastMenu="login"))},load:function(a,b){var c={};a.data.hasData&&(c.data={url:this.database.uri+a.data.doc._id+"/data.json"+(b?"?rev="+b:"")}),a.data.hasView&&(c.view={url:this.database.uri+a.data.doc._id+"/view.json"+(b?"?rev="+b:"")}),d.switchView(c,!0),this.lastKeyLoaded=a.key},saveMeta:function(a){var b=this,c=b.currentDocument,d=c.data.doc;a&&a.keywords&&a.keywords.value&&(d.keywords=a.keywords.value),d._attachments["meta.json"]={content_type:"application/json",data:g.encode(JSON.stringify(a))},b.database.saveDoc(d,{success:function(a){d._rev=a.rev,c.children&&child.lazyLoad(!0),b.showError("meta saved.",2)},error:function(){b.showError.apply(b,arguments)}})},save:function(b,c){if(!(c.length<1)){if(-1!==c.indexOf(":"))return this.showError(10);var e=d["get"+b+"JSON"](),f=this.lastNode;if("undefined"==typeof f)return this.showError(11);var h,i=f.node.getChildren();if(i)for(var j=0;j<i.length;j++)if(i[j].title===c){h=i[j];break}var k,l=this;if(h&&!h.folder)k=h.data.doc,a.ajax({url:this.database.uri+k._id+"/"+b.toLowerCase()+".json?rev="+k._rev,type:"PUT",contentType:"application/json",data:e,dataType:"json",error:this.showError,success:function(a){k._rev=a.rev,h.data["has"+b]=!0,h.children&&h.lazyLoad(!0),l.showError(b+" saved.",2)}});else{var m={},n=[];f.key&&(n=f.node.key.split(":"),n.shift()),n.push(c),m[this.flavor]=n,k={_id:a.couch.newUUID(),flavors:m,name:this.username,_attachments:{}},k._attachments[b.toLowerCase()+".json"]={content_type:"application/json",data:g.encode(e)},this.database.saveDoc(k,{success:function(a){k._rev=a.rev;var d={doc:k,lazy:!0,title:c,key:f.node.key+":"+c};d["has"+b]=!0,f.node.addNode(d),f.node.expanded||f.node.toggleExpanded(),l.showError(b+" saved.",2)}})}}},mkdir:function(b){if(!(b.length<1)){if(-1!==b.indexOf(":"))return this.showError(10);var c=this.lastNode;if("undefined"==typeof c)return this.showError(11);var d;d=c.node.folder?c.node:c.node.parent;var e=d.getChildren();if(e)for(var f=0;f<e.length;f++)if(e[f].title===b&&e[f].folder)return this.showError(12);var g=d.addNode({folder:!0,title:b,key:d.key+":"+b});d.expanded||d.toggleExpanded(),a(g.li).find(".fancytree-title").trigger("click")}},login:function(b,c){var d=this;a.couch.login({name:b,password:c,success:function(a){d.loggedIn=!0,d.username=b,d.openMenu("tree")},error:function(){d.showError.apply(d,arguments)}})},logout:function(){var b=this;a.couch.logout({success:function(){b.loggedIn=!1,b.username=null,b.openMenu("login")}})},renderLoginMethods:function(){function a(){return b.login(b.getFormContent("login-username"),b.getFormContent("login-password")),!1}for(var b=this,c=0;c<this.options.loginMethods.length;c++)switch(this.options.loginMethods[c]){case"google":this.loginForm.append('<a href=" '+b.url+'/auth/google">Google login</a><br/>');break;case"github":this.loginForm.append('<a href=" '+b.url+'/auth/github">Github login</a><br/>');break;case"facebook":this.loginForm.append('<a href=" '+b.url+'/auth/facebook">Facebook login</a><br/>');break;case"couchdb":this.loginForm.append("<div> Couchdb Login </div>"),this.loginForm.append('<label for="'+this.cssId("login-username")+'">Username </label><input type="text" id="'+this.cssId("login-username")+'" /><br>'),this.loginForm.append('<label for="'+this.cssId("login-password")+'">Password </label><input type="password" id="'+this.cssId("login-password")+'" /><br><br>'),this.loginForm.append(new e("Login",a,{color:"green"}).render()),this.loginForm.bind("keypress",function(b){return 13===b.charCode?a():void 0})}},getLoginForm:function(){var b=this.loginForm=a("<div>");return b.append("<h1>Login</h1>"),this.renderLoginMethods(),b.append(this.errorP),b},getMenuContent:function(){function c(){var a=d.getFormContent("flavor-input");d.flavor!==a&&d.changeFlavor(a)}var d=this,f=this.menuContent=a("<div>"),g=a("<div>").append(a("<p>").css("display","inline-block").css("width","50%").append("Click on an element to select it. Double-click to load.")).append(a("<p>").append("Logged in as "+this.username+" ").css("width","50%").css("text-align","right").css("display","inline-block").append(a("<a>Logout</a>").on("click",function(){d.logout()}).css({color:"blue","text-decoration":"underline",cursor:"pointer"})));f.append(g);var h=a('<input type="text" value="'+this.flavor+'" id="'+this.cssId("flavor-input")+'">');this.database.view("flavor/list",{success:function(a){d.flavorList=a.rows.length?a.rows[0].value:["default"],h.autocomplete({appendTo:"#ci-visualizer",minLength:0,source:d.flavorList}).on("autocompleteselect",function(a,b){var c=b.item.value;d.flavor!==c&&d.changeFlavor(c),h.blur()}).on("keypress",function(a){13===a.keyCode&&(c(),h.blur())})},error:function(a){console.log(a)},key:this.username}),f.append(a("<p><span>Flavor : </span>").append(h).append(new e("Switch",c,{color:"red"}).setTooltip("Switch flavor!").render()));{var i={"overflow-y":"auto",height:"200px",width:"300px"};a("<div>").attr("id",this.cssId("tree")).css(i).appendTo(f)}return this.makePublicButton=new e("Make Public",function(){console.log("Make public"),b.confirm("You are about to make your view public. This action is irreversible. It will enable anybody to access the saved view and data. Do you want to proceed?","Proceed","Cancel").then(function(a){if(a&&d.currentDocument){var b=d.currentDocument,c=b.data.doc;c.isPublic=!0,d.database.saveDoc(c,{success:function(a){c._rev=a.rev,b.data.isPublic=!0,d.updateButtons(),b.children&&child.lazyLoad(!0),d.showError("The view was made public",2)},error:function(){d.showError.apply(d,arguments)}}),console.log("proceed with make public")}})},{color:"red"}),f.append(a('<div style="width:560px; height:35px;">').append('<input type="text" id="'+this.cssId("docName")+'"/>').append(new e("Edit Meta",function(){d.metaData()},{color:"blue"}).render()).append(new e("Save data",function(){d.save("Data",d.getFormContent("docName"))},{color:"red"}).render()).append(new e("Save view",function(){d.save("View",d.getFormContent("docName"))},{color:"red"}).render()).append(new e("Mkdir",function(){d.mkdir(d.getFormContent("docName"))},{color:"blue"}).render()).append(this.errorP)),f.append("<hr>").append(this.makePublicButton.render().hide()),this.loadFlavor(),f},updateButtons:function(){var a=this.currentDocument,b=this.makePublicButton.getDom();a&&a.data&&!a.data.isPublic&&b?b.show():b&&b.hide()},getMetaForm:function(b){var c=this,d=b.data.doc;return new Promise(function(b){a.ajax({url:c.database.uri+d._id+"/meta.json",type:"GET",dataType:"json",error:function(){console.error("Could not get meta data..."),b({})},success:function(a){b(c.processMetaForm(a))}})})},processMetaForm:function(a){var b={sections:{metadata:[{sections:{keywords:[]}}]}};for(var c in a){var d={};d.contentType=[a[c].type],d.keyword=[c],"text"===a[c].type?(d.contentText=[a[c].value],d.contentHtml=[""]):"html"===a[c].type&&(d.contentHtml=[a[c].value],d.contentText=[""]),b.sections.metadata[0].sections.keywords.push({sections:{},groups:{group:[d]}})}return b},metaData:function(){var a=this;if(!this.currentDocument)return void a.showError("No document selected");var c=b.dialog({width:"80%",autoPosition:!0,title:"Edit Metadata"}),d={sections:{metadata:{options:{title:"Metadata",icon:"info_rhombus"},sections:{keywords:{options:{multiple:!0,title:"Key/Value Metadata"},groups:{group:{options:{type:"list",multiple:!0},fields:{contentType:{type:"combo",options:[{key:"text",title:"Text"},{key:"html",title:"html"}],title:"Content type",displaySource:{text:"t",html:"h"}},keyword:{type:"text",title:"Key"},contentText:{type:"jscode",mode:"text",title:"Value",displayTarget:["t"]},contentHtml:{type:"wysiwyg",title:"Value",displayTarget:["h"]}}}}}}}}},e=new h({});e.init({onValueChanged:function(a){}}),e.setStructure(d),e.onStructureLoaded().done(function(){var b;b=a.currentDocument.data.hasMeta?a.getMetaForm(a.currentDocument):Promise.resolve({}),b.then(function(a){e.fill(a)})}),e.addButton("Cancel",{color:"blue"},function(){c.dialog("close")}),e.addButton("Save",{color:"green"},function(){var b=e.getValue();a.saveMeta(a.getMetaFromForm(b)),c.dialog("close")}),e.onLoaded().done(function(){c.html(e.makeDom(1,0)),e.inDom()})},getMetaFromForm:function(a){a=DataObject.check(a,!0);var b={},c=a.getChildSync(["sections","metadata",0,"sections","keywords"]);if(c)for(var d=0;d<c.length;d++){var e=c.getChildSync([d,"groups","group",0]);"text"===e.contentType[0]?b[e.keyword[0]]={type:"text",value:e.contentText[0]}:"html"===e.contentType[0]&&(b[e.keyword[0]]={type:"html",value:e.contentHtml[0]})}return b},lazyLoad:function(b,c){var d=c.node.data.doc._id,e=a.Deferred();c.result=e.promise(),this.database.openDoc(d,{revs_info:!0,success:function(a){for(var b=a._revs_info,d=b.length,f=[],g=0;d>g;g++){var h=b[g];if("available"===h.status){var i={title:"rev "+(d-g),id:a._id,rev:h.rev,key:c.node.key};f.push(i)}}e.resolve(f)}})},clickNode:function(b,c){var d,e,f,g=d=c.node,h=g.key.indexOf(":");if(f=h>=0?g.key.substring(h+1):"",g.folder)this.currentDocument=null;else{var i;g.data.rev&&(i=g.data.rev,g=g.parent),d=g.parent,this.currentDocument=g,a("#"+this.cssId("docName")).val(g.title),this.updateButtons(),"fancytreedblclick"===b.type&&this.load(g,i)}return e={key:f,node:d},this.lastNode=e,console.log(this.lastNode.key),"fancytreedblclick"!==b.type||g.folder?void 0:!1},loadFlavor:function(){var b=a.proxy(this,"lazyLoad"),c=a.proxy(this,"clickNode"),d=this,e={delegate:"span.fancytree-title",menu:[{title:"Delete",cmd:"delete",uiIcon:"ui-icon-trash"},{title:"New flavor",cmd:"newflavor",uiIcon:"ui-icon-newwin"},{title:"Rename",cmd:"rename",uiIcon:"ui-icon-folder-collapsed"},{title:"Flavors",cmd:"flavors",children:[]}],beforeOpen:function(b,c){var e=a.ui.fancytree.getNode(c.target);if(e.folder)return!1;var f=a("#"+d.cssId("tree")),g=Object.keys(e.data.doc.flavors);if(1===g.length)f.contextmenu("setEntry","delete","Delete"),f.contextmenu("showEntry","flavors",!1);else{for(var h=new Array(g.length),i=0;i<g.length;i++)h[i]={title:g[i],cmd:"flavor"},g[i]===d.flavor&&(h[i].disabled=!0);f.contextmenu("setEntry","delete","Delete flavor"),f.contextmenu("setEntry","flavors",{title:"Flavors",children:h}),f.contextmenu("showEntry","flavors",!0)}e.setActive()},select:function(b,c){var e=a.ui.fancytree.getNode(c.target);d.contextClick(e,c.cmd,c)},createMenu:function(b){a(b.target).css("z-index",1e4)}},f={preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:300,dragStart:function(a){return!a.folder&&!a.data.rev},dragEnter:function(a){return!!a.folder},dragDrop:function(a,b){var c=b.otherNode;if(a===c.parent)return!1;var e=a.key.substring(d.flavor.length+1);e+=e.length?":"+c.title:c.title;var f=e.split(":");d.database.view("flavor/docs",{success:function(e){return m(f,e.rows)?d.showError(21):(c.data.doc.flavors[d.flavor]=f,void d.database.saveDoc(c.data.doc,{success:function(){c.moveTo(a,b.hitMode)},error:function(){d.showError.apply(d,arguments)}}))},error:function(a){console.log(a)},key:[d.flavor,d.username],include_docs:!1})}};this.database.list("flavor/sort","docs",{key:[this.flavor,this.username],include_docs:!0},{success:function(g){var h=j(g,d.flavor),i=a("#"+d.cssId("tree"));i.fancytree({toggleEffect:!1,extensions:["dnd"],dnd:f,source:[],lazyLoad:b,dblclick:c,debugLevel:0,activate:c}).children("ul").css("box-sizing","border-box");var k=i.data("ui-fancytree").getTree();if(k.reload(h),k.getNodeByKey(d.flavor).toggleExpanded(),i.contextmenu(e),d.lastKeyLoaded&&k.activateKey(d.lastKeyLoaded),d.currentDocument){var l=d.currentDocument.data.doc._id,m=_.find(g,function(a){return a.id===l});if(m){var n=_.flatten([d.flavor,m.value.flavors]).join(":");k.activateKey(n)}}},error:function(a){console.log(a)}})},contextClick:function(c,d,e){var f=this;if(!c.folder)if("delete"===d)c.data.rev&&(c=c.parent),delete c.data.doc.flavors[this.flavor],a.isEmptyObject(c.data.doc.flavors)?(c.data.doc._deleted=!0,this.database.saveDoc(c.data.doc,{success:function(){f.showError("Document deleted.",2),c.remove()},error:function(){f.showError.apply(f,arguments)}})):this.database.saveDoc(c.data.doc,{success:function(){f.showError("Flavor deleted.",2),c.remove()},error:function(){f.showError.apply(f,arguments)}});else if("rename"===d)b.dialog('New name : <input type="text" id="'+this.cssId("newname")+'" value="'+c.title+'" />',{buttons:{Save:function(){var b=a(this),d=c.data.doc,e=f.getFormContent("newname"),g=d.flavors[f.flavor],h=g[g.length-1];g[g.length-1]=e,f.database.view("flavor/docs",{success:function(a){return m(g,a.rows)?(g[g.length-1]=h,f.showError(21)):void f.database.saveDoc(d,{success:function(){c.key=c.key.replace(/[^:]+$/,e),c.setTitle(e),b.dialog("destroy")},error:function(a){console.log(a)}})},error:function(a){console.log(a)},key:[f.flavor,f.username],include_docs:!1})},Cancel:function(){a(this).dialog("destroy")}}});else if("newflavor"===d){var g=a("<div>").html("Flavor :");b.dialog(g,{buttons:{Save:function(){var b=a(this),d=c.data.doc,e=f.getFormContent("newflavorname");if(d.flavors[e])f.showError(20);else{var g=d.flavors[f.flavor];f.database.view("flavor/docs",{success:function(a){return m(g,a.rows)?f.showError(21):(d.flavors[e]=g,void f.database.saveDoc(d,{success:function(){f.showError("Flavor "+e+" successfully added.",2),b.dialog("destroy")},error:function(a){console.log(a)}}))},error:function(a){console.log(a)},key:[e,f.username],include_docs:!1})}},Cancel:function(){a(this).dialog("destroy")}},title:"New flavor"}),g.append(a('<input type="text" id="'+this.cssId("newflavorname")+'" />').autocomplete({appendTo:"#ci-visualizer",minLength:0,source:f.flavorList}))}else"flavor"===d?f.changeFlavor(e.item.text()):"flavors"===d||console.warn('Context menu action "'+d+'" not implemented !')}}),Object.defineProperty(i.prototype,"flavor",{get:function(){return this._flavor?this._flavor:this._flavor=window.sessionStorage.getItem("ci-visualizer-pouchdb2-flavor")||"default"},set:function(a){this._flavor=a,window.sessionStorage.setItem("ci-visualizer-pouchdb2-flavor",a)}}),i});