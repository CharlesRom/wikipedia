define(["require","jquery","src/util/api","src/util/util","src/util/datatraversing"],function(a,b,c,d,e){function f(c,e,f,g){f=b.extend({},k,f),a([j],function(a){var h=d.getNextUniqueId(),i='<div id="'+h+'" style="width:100%; height:100%" />';g.build=function(){var g=b("#"+h),i=Math.max(150,g.height()),j=g.width(),k=d.getNextUniqueId(),l=b("<canvas>",{id:k}),m=l.get(0);m.height=i,m.width=j,g.html(l),a.StructureView.drawStructure(k,c,e,f)},g.resolve(i)})}function g(b,c,e){a(["lib/bio-pv/bio-pv.min"],function(a){var f=d.getNextUniqueId(),g='<div id="'+f+'" style="width:99%; height:99%" />';c.build=function(){var c;"pdb"===b?c=a.io.pdb(e):"mol3d"===b&&(c=a.io.sdf(e));var d=a.Viewer(document.getElementById(f),{width:"auto",height:"auto",quality:"medium"});d.addListener("viewerReady",function(){if("pdb"===b){var a=c.select({rnames:["RVP","SAH"]});d.ballsAndSticks("ligand-"+f,a),d.cartoon(f,c)}else"mol3d"===b&&d.ballsAndSticks(f,c);d.fitTo(c)})},c.resolve(g)})}function h(a,c,d,f,g){var h=e.getType(c),j=e.getHighlights(c);if(f=b.extend(f,e.getOptions(c)),!i[h])return a.resolve("");var k=c;c=e.get(c),!i[h].ready&&i[h].init&&(i[h].init(),i[h].ready=!0),i[h].toscreen(a,c,k,f,j,d,g)}d.loadCss("components/font-awesome/css/font-awesome.min.css");var i={};i.string={},i.string.toscreen=function(a,b){for(b=String(b);;)if(b=b.replace("<","&lt;").replace(">","&gt;"),-1===b.indexOf("<")&&-1===b.indexOf(">"))break;a.resolve(b)},i.date={},i.date.toscreen=function(a,b){try{var c=new Date(b);a.resolve(c.toLocaleString())}catch(b){a.resolve("Invalid date")}},i.color={},i.color.toscreen=function(a,b){var c='<div style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAIAAADZF8uwAAAAGUlEQVQYV2M4gwH+YwCGIasIUwhT25BVBADtzYNYrHvv4gAAAABJRU5ErkJggg==); width:100%; height:100%"><div style="background-color: '+b+'; width: 100%; height:100%; padding:0; margin:0"></div></div>';a.resolve(c)},i.html={},i.html.toscreen=function(a,b){a.resolve(String(b))},i.matrix={},i.matrix.toscreen=function(a,b){a.resolve(b)},i.number={},i.number.toscreen=function(a,b){a.reject(b.valueOf())},i.chemical={},i.chemical.toscreen=function(a,b){b.getChild(["iupac","0","value"]).then(a.resolve,a.reject)},i.picture={},i.picture.toscreen=function(a,b){a.reject('<img src="'+b+'" />')},i.svg={},i.svg.toscreen=function(a,c){var d=b(c),e=[0,0,parseInt(d.attr("width")),parseInt(d.attr("height"))];d[0].setAttribute("viewBox",e.join(" ")),d.removeAttr("id"),d.attr("width","100%"),d.attr("height","100%"),a.resolve(b("<div>").append(d).html())},i.gif=i.picture,i.jpeg=i.picture,i.jpg=i.picture,i.png=i.picture,i.doi={},i.doi.toscreen=function(a,b){return a.resolve(b.replace(/^(.*)$/,'<a target="_blank" href="http://dx.doi.org/$1"><img src="bin/logo/doi.png" /></a>'))};var j="components/openchemlib/dist/openchemlib-viewer",k={suppressChiralText:!0,suppressESR:!0,suppressCIPParity:!0,noStereoProblem:!0};return i.jme={},i.jme.toscreen=function(b,c,d,e,f,g){a(["lib/chemistry/jme-converter"],function(a){var d=a.toMolfile(c),h={type:"mol2d",value:d};i.mol2d.toscreen(b,d,h,e,f,g)})},i.smiles={},i.smiles.toscreen=function(b,c,d,e,g,h){a([j],function(a){var d=a.Molecule.fromSmiles(String(c));f(d.getIDCode(),d.getIDCoordinates(),e,b)})},i.actelionID={},i.actelionID.toscreen=function(b,c,d,e,g,h){a([j],function(a){if(!d.coordinates){var c=String(d.value),g=a.Molecule.fromIDCode(c,!0);Object.defineProperty(d,"coordinates",{configurable:!0,enumerable:!1,value:g.getIDCoordinates(),writable:!0})}f(String(d.value),String(d.coordinates),e,b)})},i.mol2d={},i.mol2d.toscreen=function(b,c,d,e,g,h){a([j],function(a){var d=a.Molecule.fromMolfile(c);f(d.getIDCode(),d.getIDCoordinates(),e,b)})},i.molfile2D=i.mol2d,i.jcamp={},i.jcamp.hexToRgb=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null},i.id=0,i.cache=[],i.jcamp.toscreen=function(c,d,e,f,g,h){a(["lib/plot/plot","components/jcampconverter/dist/jcampconverter.min"],function(a,d){var f=b("<div />").css({width:200,height:200}),g=new a(f.get(0),{closeRight:!1,closeTop:!1,zoomMode:""},{bottom:[{unitModification:!1,primaryGrid:!1,nbTicksPrimary:5,nbTicksSecondary:2,secondaryGrid:!1,axisDataSpacing:{min:0,max:0}}],left:[{ticklabelratio:1,primaryGrid:!0,nbTicksSecondary:4,secondaryGrid:!1,nbTicksPrimary:2,forcedMin:0,axisDataSpacing:{min:0,max:0}}]});g.resize(200,200),e=d.convert(e.value);var h=g.newSerie("serie",{lineToZero:!0});h.autoAxis(),h.setData(e.spectra[0].data[0]),c.resolve(g._dom),g.redraw(),g.drawSeries()})},i.mf={},i.mf.toscreen=function(a,b){return a.reject(b.replace(/\[([0-9]+)/g,"[<sup>$1</sup>").replace(/([a-zA-Z)])([0-9]+)/g,"$1<sub>$2</sub>").replace(/\(([0-9+-]+)\)/g,"<sup>$1</sup>"))},i.pdb={},i.pdb.toscreen=g.bind(i.pdb,"pdb"),i.mol3d={},i.mol3d.toscreen=g.bind(i.pdb,"mol3d"),i.molfile3D=i.mol3d,i.cif={},i.cif.toscreen=function(a,b){return a.resolve(b)},i.downloadLink={},i.downloadLink.toscreen=function(a,b){return a.resolve(b.replace(/^(.*)$/,'<a href="$1">â¤µ</a>'))},i.boolean={},i.boolean.toscreen=function(a,b){a.resolve(b?'<span style="color: green;">&#10004;</span>':'<span style="color: red;">&#10008;</span>')},i.colorBar={},i.colorBar.toscreen=function(a,c){var d=b("<div>"),e="linear-gradient(to right",f=0,g=0,h=c.length;for(g=0;h>g;f+=c[g++][0]);var i,j,k=0;for(g=0;h>g;g++)i=k+c[g][0]/f*100,j=c[g][1],e+=", "+j+" "+k+"%, "+j+" "+i+"%",k=i;e+=")",d.css({height:"100%",width:"100%"}).css("background",e),a.resolve(d.get(0))},i.indicator={},i.indicator.init=function(){var a,c=b('<div class="ci-tooltip"></div>').css({display:"none",opacity:0}).appendTo("#ci-visualizer");b("#modules-grid").on("mouseenter","[data-tooltip]",function(d){a=setTimeout(function(){var a=b(d.target),e=a.offset();c.css({left:e.left,top:e.top,display:"block"}).text(a.attr("data-tooltip")),c.animate({opacity:1})},500)}),b("#modules-grid").on("mouseleave","[data-tooltip]",function(b){clearTimeout(a),c.css({opacity:0,display:"none"})})},i.indicator.toscreen=function(c,d){a(["src/util/color"],function(a){Array.isArray(d)||c.reject("");var e='<table cellpadding="0" cellspacing="0" style="text-align: center; height:100%; width:100%"><tr>';isNaN(d[0])||(d=d.map(function(a){return{size:a}}));for(var f=d.length,g=a.getDistinctColors(d.length),h=0,i=0;f>i;i++)d[i].bgcolor||(d[i].bgcolor=a.getColor(g[i])),d[i].size||0===d[i].size||(d[i].size=10),h+=d[i].size;for(var i=0;f>i;i++){var j=d[i],k=b("<td>").css({width:100*j.size/h+"%",border:"none"});j.bgcolor&&k.css("background-color",j.bgcolor),j.color&&k.css("color",j.color),j.text&&k.append(j.text),j.class&&k.addClass(j.class),j.icon&&k.prepend('<i class="fa fa-'+j.icon+'"></i>'),j.css&&k.css(j.css),j.tooltip&&k.attr("data-tooltip",j.tooltip),e+=k.get(0).outerHTML}e+="</tr></table>",c.resolve(e)})},i.styledValue={},i.styledValue.toscreen=function(a,c,d,e,f,g,h){var j=b("<div>");j.css(c.css),i.toScreen(c.value,g,e,h).always(function(b){j.append(b),a.resolve(j.get(0))})},i.regexp={},i.regexp.toscreen=function(c,e){var f=String(e);a(["lib/regexper/regexper"],function(a){var e=d.getNextUniqueId(),g='<div id="'+e+'" />';c.build=function(){var c=b("#"+e)[0],d=new a(c);d.parse(f).invoke("render")},c.resolve(g)})},i.regex=i.regexp,{toScreen:function(a,c,d,e){var f=b.Deferred();return a=DataObject.check(a,!0),e?(a.getChild(e).then(function(a){h(f,a,c,d,e)},function(){f.reject()}),f):(h(f,a,c,d,e),f)},addType:function(a,b){i[a]=b}}});