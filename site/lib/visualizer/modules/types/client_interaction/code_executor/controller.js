define(["modules/types/client_interaction/code_editor/controller","src/util/api","src/util/debug","src/util/sandbox"],function(a,b,c,d){function e(){this.currentScript=null}function f(a,b){this.controller=a,this.libs=b;var c=g(this),e=this.controller.module.view._code;this._sandbox=new d,this._sandbox.setContext(c),this._sandbox.run("var __exec__ = function("+a.neededAliases+") {"+e+"\n};"),this.theFunction=this._sandbox.getContext().__exec__,this.outputVariable={}}function g(a){var c=function(b,c){a.doVariable(b,c)},d={variables:{},event:null,button:null,action:null,defined:0,set:c,get:function(a){return this.variables[a]}},e={getVariables:function(){return d.variables},getEvent:function(){return d.event},getButton:function(){return d.button},get:function(a){return d.variables[a]},getDefined:function(){return d.defined},set:c,getAction:function(){return d.action},sendAction:function(a,c){b.doAction(a,c)},setAsync:function(){a.async()},done:function(){a.done()}};return a.context=d,e}return e.prototype=Object.create(a.prototype),e.prototype.moduleInformation={name:"Code executor",description:"Write code that can be executed on input variable, action or just the push of a button",author:"MichaÃ«l Zasso",date:"12.01.2015",license:"MIT"},e.prototype.references={inputValue:{label:"Input value"},outputValue:{label:"Output value"}},e.prototype.events={onScriptEnded:{label:"Code execution ended",refVariable:["outputValue"]}},e.prototype.variablesIn=["inputValue"],e.prototype.actionsIn.execute="Execute the code",e.prototype.configurationStructure=function(){return{groups:{group:{options:{type:"list"},fields:{display:{type:"checkbox",title:"Display",options:{editor:"Code editor",buttons:"Buttons"},default:["editor","buttons"]},script:{type:"jscode",title:"Code",default:""}}},libs:{options:{type:"table",multiple:!0,title:"Required libraries"},fields:{lib:{type:"text",title:"url"},alias:{type:"text",title:"alias"}}},buttons:{options:{type:"table",multiple:!0,title:"Buttons"},fields:{name:{type:"text",title:"Name",default:"button1"},label:{type:"text",title:"Label",default:"Execute"}}}}}},e.prototype.configAliases={script:["groups","group",0,"script",0],display:["groups","group",0,"display",0],libs:["groups","libs",0],buttons:["groups","buttons",0]},e.prototype.onButtonClick=function(a){this.initExecutor().then(function(b){b.setButton(a),b.execute()})},e.prototype.onVariableIn=function(){this.initExecutor().then(function(a){a.setVariable(),a.execute()})},e.prototype.onActionIn=function(a,b){this.initExecutor().then(function(c){c.setAction(a,b),c.execute()})},e.prototype.initImpl=function(){var a=this.module.getConfiguration("libs"),b=[],c=[];if(a)for(var d=0;d<a.length;d++){var e=a[d];e.lib&&(b.push(e.lib),c.push(e.alias||"required_anonymous_"+d))}b.unshift("src/util/api"),c.unshift("API"),this.neededUrls=b,this.neededAliases=c.join(", "),this.resolveReady()},e.prototype.initExecutor=function(){var a,b=this.module.view._code;if(this.currentScript==b)a=Promise.resolve(this._executor||this._loadingExecutor);else{var c=this,d=new Promise(function(a,d){require(c.neededUrls,function(){for(var d=new Array(c.neededUrls.length),e=0;e<c.neededUrls.length;e++)d[e]=arguments[e];c._executor&&c._executor._sandbox.close();var g=new f(c,d);c.currentScript=b,c._executor=g,c._loadingExecutor=null,a(g)})});this._loadingExecutor=d,a=d}return a.then(function(a){return a.init(),a})},f.prototype.init=function(){this.context.event=null,this.context.button=null,this.context.action=null,this.context.variables={},this.context.defined=0,this.outputVariable={}},f.prototype.setButton=function(a){this.context.event="button",this.context.button=a},f.prototype.setVariable=function(){this.context.event="variable"},f.prototype.setAction=function(a,b){this.context.event="action",this.context.action={name:a,value:b}},f.prototype.doVariable=function(a,b){this.outputVariable[a]=b},f.prototype.execute=function(){var a=this.controller.module.view._input,b={},d=0;for(var e in a)null!=a[e]&&(d++,b[e]=a[e]);this.context.variables=b,this.context.defined=d,this._async=!1,this._done=Promise.resolve();try{this.theFunction.apply(this.context,this.libs)}catch(a){a&&a.stack&&(a=a.stack),c.error("Code executor error",a)}this.setOutput()},f.prototype.setOutput=function(){var a=this;this._done.then(function(){a.controller.lastData=a.outputVariable,a.controller.createDataFromEvent("onScriptEnded","outputValue",a.outputVariable)},function(a){c.error("Code executor error",a)})},f.prototype.async=function(){if(!this._async){this._async=!0;var a=this;this._done=new Promise(function(b,c){a.done=function(a){a instanceof Error?c(a):b(a)}})}},f.prototype.done=function(){},e});