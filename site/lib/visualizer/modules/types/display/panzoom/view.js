define(["src/util/api","src/util/debug","modules/default/defaultview","src/util/util","lodash","bowser","components/jquery.panzoom/dist/jquery.panzoom","components/jquery-mousewheel/jquery.mousewheel"],function(a,b,c,d,e,f){function g(){}function h(a){if(6!==a.length)throw new Error("getCssTransform expects array of length 6");return"matrix("+a.join(",")+")"}var i=Promise.resolve();return $.extend(!0,g.prototype,c,{init:function(){this.toHide=this.toHide||{},this.transforms=this.transforms||{};var a=this;this.dom||(this._id=d.getNextUniqueId(),this.dom=$(' <div id="'+this._id+'"></div>').css("height","100%").css("width","100%"),this.module.getDomContent().html(this.dom)),this.dom.off("mouseleave"),this.dom.on("mouseleave",function(){a.highlightOff()}),this.images=[],this.state="done"},blank:{picture:function(){}},inDom:function(){this.resolveReady()},update:{picture:function(a,b){var c=this;return c.doImage(b,a,{},!0)}},clearImages:function(){if(!this.images)return void(this.images=[]);for(var a=0;a<this.images.length;a++)this.images[a].$panzoomEl.panzoom("destroy");this.dom.html(""),this.images=[]},doImage:function(a,c,d,e){var f=this;i=i.then(function(){return f.addImage(a,c,d)}).then(function(){f.panzoomMode(a),f.reorderImages(),e&&(f.processHighlights(),f.listenHighlights())},function(a){b.warn("panzoom: image failed to load",a)})},reorderImages:function(){for(var a=0;a<this.images.length;a++)this.images[a].$panzoomEl.css("z-index",parseInt(this.images[a].conf.order)||a)},addImage:function(b,c,d){var f=this;return new Promise(function(g,i){function j(){p.name=k.variable,p.$panzoomEl=l.find(".panzoom"),p.$parent=p.$panzoomEl.parent(".parent"),p.$img=m,p.width=this.width,p.height=this.height,p.conf=k,p.transform=null;var a=p.conf.scaling;if("maxIfLarge"===a&&(a=p.width>f.width||p.height>f.height?"max":"no"),"max"===a&&(p.width/p.height>f.width/f.height?(p.f=f.width/p.width,p.transform=h([p.f,0,0,p.f,0,0])):(p.f=f.height/p.height,p.transform=h([p.f,0,0,p.f,0,0]))),"asHighlight"===a&&f.himg.f){var b=[f.himg.f,0,0,f.himg.f,f.highlightImage.shiftx*f.himg.f,f.highlightImage.shifty*f.himg.f];p.transform=h(b)}f.dom.append(l),o||f.images.push(p),n&&n.remove(),m.css({transform:p.transform,transformOrigin:"0 0",display:"block"}),m.show(),g()}void 0===c&&(c=a.getData(b));var k=e.find(f.module.getConfiguration("img"),function(a){return a.variable===b});if(k=f._completeConf(k,b,d),!k.variable)throw new Error("panzoom: conf is expected to have a variable name");var l=f.dom.find("#"+f.getImageDomId(b));l.find(".panzoom").panzoom("destroy");var m;if(0===l.length&&"__highlight__"!==b)l=f.newImageDom(b),m=l.find("img");else if("__highlight__"!==b){var n=l.find("img");m=$('<img style="display: none;"/>'),l.find(".panzoom").append(m)}else 0===l.length?(l=f.newCanvasDom(b),m=$(f.highlightImage.canvas),l.find(".panzoom").append(m)):(l.find("canvas").remove(),m=$(f.highlightImage.canvas),l.find(".panzoom").append(m));var o=!1,p=e.find(f.images,function(a){return a.name===b});if(p&&(o=!0),p=p||{},f.toHide&&f.toHide[k.variable])return n&&n.hide(),m.remove(),g();var q;q="__highlight__"===b?f.highlightImage.dataUrl:c.get(),m.css("opacity",k.opacity).addClass(k.rendering),"__highlight__"===b?j.call(f.highlightImage.canvas):m.attr("src",q).on("load",j).on("error",function(a){n&&n.remove(),i(a)})})},processHighlights:function(){var c;this.highlights=null;for(var e=0;e<this.images.length;e++)"__highlight__"!==this.images[e].name&&a.getData(this.images[e].name)._highlight&&(c=this.images[e]);if(c){var f=a.getData(c.name);if(f._highlight.length!==c.width*c.height)return void b.warn("Panzoom: unexpected highlight length");this._highlight=f._highlight,this.himg=c,this.highlights={};for(var e=0;e<f._highlight.length;e++){var g=f._highlight[e];"Array"!==d.objectToString(g)&&(g=[g]);for(var h=0;h<g.length;h++)if(void 0!==g[h]){this.highlights[g[h]]?this.highlights[g[h]].data.push(e):this.highlights[g[h]]={data:[e],shiftx:e%c.width,shifty:e/c.width|0,shiftX:e%c.width,shiftY:e/c.width|0};var i=e/c.width|0,j=e%c.width;j<this.highlights[g[h]].shiftx?this.highlights[g[h]].shiftx=j:j>this.highlights[g[h]].shiftX&&(this.highlights[g[h]].shiftX=j),i<this.highlights[g[h]].shifty?this.highlights[g[h]].shifty=i:i>this.highlights[g[h]].shiftY&&(this.highlights[g[h]].shiftY=i)}}for(var k in this.highlights)this.highlights[k].width=this.highlights[k].shiftX-this.highlights[k].shiftx+1,this.highlights[k].height=this.highlights[k].shiftY-this.highlights[k].shifty+1}},listenHighlights:function(){var b=this;if(a.killHighlight(this.module.getId()),this.highlights){var c=Object.keys(this.highlights);b._highlighted=[];for(var d=0;d<c.length;d++)!function(d){a.listenHighlight({_highlight:c[d]},function(a,c){Array.isArray(c)||(c=[c]),b._highlighted=a?e(b._highlighted).push(c).flatten().uniq().value():e.filter(b._highlighted,function(a){return-1===c.indexOf(a)}),b._drawHighlight()},!1,b.module.getId())}(d)}},_drawHighlight:function(){this._highlighted&&this._highlighted.length?(this.toHide.__highlight__=!1,this.highlightImage=this._createHighlight(this._highlighted)):(this.toHide.__highlight__=!0,this.highlightImage=this.highlightImage||{},this.highlightImage.dataUrl="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),this.doImage("__highlight__")},newImageDom:function(a){return $('<div class="parent" id="'+this.getImageDomId(a)+'"><div class="panzoom"><img style="display: none;"/></div></div>')},newCanvasDom:function(a){return $('<div class="parent" id="'+this.getImageDomId(a)+'"><div class="panzoom"></div></div>')},getImageDomId:function(a){return"ci-panzoom-image-"+a},panzoomMode:function(a){function b(a,b,d){for(var e=0;e<c.images.length;e++){var f=c.images[e].$img[0].getBoundingClientRect(),g={x:(a.pageX-f.left)*c.images[e].width/f.width|0,y:(a.pageY-f.top)*c.images[e].height/f.height|0};g.x>=0&&g.x<c.images[e].width&&g.y>=0&&g.y<c.images[e].height&&(0===e&&(d.x=g.x,d.y=g.y),b[c.images[e].name]=g)}}var c=this,d=0,f=this.images.length;if(a){var g=e.findIndex(c.images,function(b){return b.name===a});d=-1===g?void 0:g,f=g+1}for(var h=d;f>h;h++){if(c.images[h].$panzoomEl.panzoom({increment:.1,maxScale:100,minScale:1e-6,duration:0,startTransform:"none",onEnd:function(){"pan"===c.state&&$(this).css("cursor","pointer")}}).css("cursor","pointer"),c.lastTransform){var i=c.images[h].$panzoomEl.panzoom("instance");i.setMatrix(c.lastTransform)}c.images[h].$panzoomEl.off("panzoompan"),c.images[h].$panzoomEl.on("panzoompan",function(a,b){c.lastTransform=b.getMatrix();for(var d=0;d<c.images.length;d++){"done"===c.state&&(c.images[d].$panzoomEl.css("cursor","move"),c.state="pan");var e=c.images[d].$panzoomEl.panzoom("instance");e!==b&&e.setMatrix(c.lastTransform)}})}c.dom.off("mousewheel.focal"),c.dom.on("mousewheel.focal",function(a){a.preventDefault();var b=1,d=.2;if(c.images.length>0){var e=c.images[0].$panzoomEl.panzoom("getMatrix")[0];b=d*e}var f=a.delta||a.originalEvent.wheelDelta,g=f?0>f:a.originalEvent.deltaY>0;c.images[0].$panzoomEl.panzoom("zoom",g,{increment:b,animate:!1,focal:a}),c.lastTransform=c.images[0].$panzoomEl.panzoom("getMatrix");for(var h=1;h<c.images.length;h++){var i=c.images[h].$panzoomEl.panzoom("instance");i.setMatrix(c.lastTransform)}c.rerender()}),c.dom.off("click.panzoom"),c.dom.on("click.panzoom",function(a){if("pan"===c.state)return void(c.state="done");c.state="done",$(this).css("cursor","pointer");var d={},f={};b(a,d,f),e.isEmpty(f)||c.module.controller.clickedPixel(f),e.isEmpty(d)||c.module.controller.allClickedPixels(d)}),c.dom.off("mousemove.panzoom"),c.dom.on("mousemove.panzoom",function(a){if("pan"!==c.state){var d={},f={};b(a,d,f),e.isEmpty(f)||e.isEqual(DataObject.resurrect(c.lastHoverPixel),f)||(c.module.controller.hoverPixel(f),c.lastHoverPixel=f,c.highlightOn(f)),e.isEmpty(f)&&c.highlightOff(),e.isEmpty(f)||void 0!==c._hl||c.highlightOn(f),e.isEmpty(d)||e.isEqual(DataObject.resurrect(c.lastAllHoverPixels),d)||(c.module.controller.allHoverPixels(d),c.lastAllHoverPixels=d)}}),this.dom.off("dblclick"),this.dom.dblclick(function(){for(var a=0;a<c.images.length;a++)c.images[a].$panzoomEl.panzoom("reset"),0===a&&(c.lastTransform=c.images[a].$panzoomEl.panzoom("getMatrix"))})},_createHighlight:function(a){if(!this.highlights)return null;Array.isArray(a)||(a=[a]);for(var b=1/0,c=1/0,d=-(1/0),e=-(1/0),f=0;f<a.length;f++){var g=a[f];b=Math.min(b,this.highlights[g].shiftx),c=Math.min(c,this.highlights[g].shifty),d=Math.max(d,this.highlights[g].shiftX),e=Math.max(e,this.highlights[g].shiftY)}var h=document.createElement("canvas"),i=e-c+1,j=d-b+1;h.height=i,h.width=j;for(var k=h.getContext("2d"),l=k.createImageData(j,i),m=l.data,f=0;i*j>f;f++)m[4*f]=255,m[4*f+1]=255,m[4*f+2]=153,m[4*f+3]=0;for(var n=0;n<a.length;n++)for(f=0;f<this.highlights[a[n]].data.length;f++){var o=this.highlights[a[n]].data[f],p=o%this.himg.width,q=o/this.himg.width|0,r=p-b,s=q-c,t=s*j+r;m[4*t+3]=255}return k.putImageData(l,0,0),{canvas:h,shiftx:b,shifty:c}},highlightOn:function(b){var c=this;if(d.isArray(c._highlight)){var e=b.x+c.himg.width*b.y;c._highlight[e]?c._hl!==c._highlight[e]&&(a.highlightId(c._hl,0),a.highlightId(c._highlight[e],1),c._hl=c._highlight[e]):c._hl&&c.highlightOff()}},highlightOff:function(){void 0!==this._hl&&(a.highlightId(this._hl,0),this._hl=void 0)},rerender:e.debounce(function(){for(var a=0;a<this.images.length;a++)(this.images[a].conf.rerender&&this.images[a].conf.rerender.indexOf("yes")>-1||"crisp-edges"===this.images[a].conf.rendering&&f.chrome)&&this.doImage(this.images[a].name)},300),chromeCrisp:e.debounce(function(){for(var a=0;a<this.images.length;a++)"crisp-edges"===this.images[a].conf.rendering&&this.doImage(this.images[a].name)},300),onResize:function(){this.doAllImages()},doAllImages:function(){for(var a=0;a<this.images.length;a++)this.doImage(this.images[a].name)},getDom:function(){return this.dom},onActionReceive:{hide:function(a){var b;b="string"==typeof a?a:a.name,this.toHide[b]||(this.toHide[b]=!0,this.doImage(b))},show:function(a){this.toHide=this.toHide||{};var b;b="string"==typeof a?a:a.name,this.toHide[b]&&(this.toHide[b]=!1,this.doImage(b))}},_getDefaultConf:function(){return{opacity:.5,"z-index":1,rendering:"Normal",scaling:"max"}},_completeConf:function(a,b,c){if(!a)return this._completeConf(this._getDefaultConf(),b,c);"__highlight__"===b&&(c={"z-index":1e6,scaling:"asHighlight",rendering:"crisp-edges"}),a.variable=b;var d=e.assign(a,c);return d}}),g});