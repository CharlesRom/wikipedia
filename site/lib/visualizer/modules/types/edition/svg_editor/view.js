require.config({paths:{svgsanitize:"lib/svg-edit-2.7/sanitize"},shim:{svgsanitize:["lib/svg-edit-2.7/svgedit","lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgutils"],"lib/svg-edit-2.7/svgutils":["lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgtransformlist","lib/svg-edit-2.7/units"],"lib/svg-edit-2.7/svgtransformlist":["lib/svg-edit-2.7/browser"]}}),define(["require","src/util/api","lodash","modules/default/defaultview","src/util/typerenderer","src/util/util","src/util/datatraversing","lib/svg-edit-2.7/embedapi","svgsanitize"],function(a,b,c,d,e){function f(){var a=this;this.svgCanvas=null,this.iframeLoaded=$.Deferred(),this.iframeLoaded.done(function(){a.svgCanvas.zoomChanged(window,"canvas")})}var g=c.throttle(function(){function a(a){c[0].module.definition.configuration.groups.group[0].svgcode=[a],c[0].module.controller.onChange(a)}function b(b,c){return c?void console.error("Unable to get svg from iframe"):void a(b)}var c=arguments;if(c[0]._configCheckBox("editable","isEditable"))setTimeout(function(){c[0].svgCanvas.getSvgString()(b)},0);else{var d=c[0].dom.clone(),e=d[0].getAttribute("viewBox").split(" ");d.attr("width",e[2]).attr("height",e[3]).removeAttr("viewBox"),d=d.wrap("<p/>").parent().html(),a(d)}},1e3),h=["animate","set","animateMotion","animateColor","animateTransform"],i={begin:"indefinite",options:{clearOnEnd:!1,persistOnEnd:!1,clearAnimationTagsOnEnd:!1,clearAnimationTagsBeforeBegin:!1}},j=["options","tag","attributes"],k=["click","dblclick","mouseenter","mouseleave"],l={},m={},n={};return $.extend(!0,f.prototype,d,{init:function(){var a=this;if(this._configCheckBox("editable","isEditable"))this.dom&&this.dom.remove(),this.svgCanvas=null,this.dom=$('<iframe src="lib/svg-edit-2.7/svg-editor.html?extensions=ext-xdomain-messaging.js'+window.location.href.replace(/\?(.*)$/,"&$1")+'"></iframe>'),this.module.getDomContent().html(this.dom),this.dom.bind("load",function(){var b=a.dom[0];a.svgCanvas=new EmbeddedSVGEdit(b),a.iframeDoc=b.contentDocument||b.contentWindow.document,a.svgEditor=b.contentWindow.svgEditor,b.contentWindow.svgedit.options={},a.svgCanvas.bind("changed",function(){a.svgEditor.showSaveWarning=!1,a._saveSvg()}),a._loadSvg(),a.iframeLoaded.resolve(),a.resolveReady(),a.onResize()});else{var b=a.module.getDomContent();e.render(b,{type:"svg",value:a.module.getConfiguration("svgcode")}).catch(function(){b.html("<svg></svg>")}).then(function(){a.dom=b.find("svg"),a.resolveReady()})}},onResize:function(){this._configCheckBox("editable","isEditable")&&this.dom&&(this.dom.height(this.height).width(this.width),this.svgCanvas&&this.svgCanvas.zoomChanged(window,"canvas"))},update:{svgModifier:function(a){this.modifySvgFromArray(a,!0)}},addAnimation:function(a,b){var d=this,e=$([]);if(b.attributes){{a.attr("id")}if(b.tag=b.tag||"animate",-1!==h.indexOf(b.tag)){Array.isArray(b.attributes)||(b.attributes=[b.attributes]),b=c.defaults(b,i);var f=d.getHighlightId(a),g={};for(var k in b)-1===j.indexOf(k)&&(g[k]=c.cloneDeep(b[k]));for(var l=0;l<b.attributes.length;l++){b.attributes[l]=c.defaults(b.attributes[l],g),a.each(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",b.tag);for(var c in b.attributes[l]){var d=b.attributes[l][c];d="function"==typeof d?d.call():d,a.setAttributeNS(null,c,d)}$(this).append(a)});var o=a.children(":last-child");e=e.add(o)}e.each(function(c,g){this.addEventListener("endEvent",function(){if(n[f]=!1,b.options.persistOnEnd&&("animate"===b.tag?a.attr(this.getAttribute("attributeName"),this.getAttribute("to")):console.warn("Could not persist animation")),b.options.clearAnimationTags&&d.$getAnimationTags(a).remove(),b.options.clearOnEnd){var c=b.options.clearOnEnd.timeout||0;setTimeout(function(){$(g).remove(),d._saveSvg()},c)}}),this.addEventListener("repeatEvent",function(){}),this.addEventListener("beginEvent",function(){b.options.clearAnimationTagsBeforeBegin&&(d.$getAnimationTags(a).not(e).remove(),m[f]=0,n[f]=!0)}),"indefinite"===this.getAttribute("begin")&&this.beginElement()})}}},addAnimations:function(a,b){if(Array.isArray(b))for(var c=0;c<b.length;c++)this.addAnimation(a,b[c]);else this.addAnimation(a,b)},setAttributesOneByOne:function(a,b){for(var c in b)"function"==typeof b[c]?a.each(function(){this.setAttribute(c,b[c].call())}):a.attr(c,b[c])},removeStyleProperties:function(a,b){a.each(function(){for(var a in b)this.style.removeProperty(a)})},modifySvgFromArray:function(a,b){var c=this;Array.isArray(a)||(a=[a]),this.$svgcontent=this._configCheckBox("editable","isEditable")?$(c.iframeDoc).find("#svgcontent"):c.dom,c.module._data=[];for(var d=0;d<a.length;d++)this.modifySvgFromObject(a[d],b);c._saveSvg()},modifySvgFromObject:function(a,d){function e(){$(this).css("cursor","pointer"),i.module.controller.onHover(a.info||{})}function f(){$(this).css("cursor","default")}function g(){i.module.controller.onClick(a.info||{})}function h(a){if(!n[s]){var b={};b.tag="animateTransform",b.options={clearOnEnd:!1,persistOnEnd:!1},b.attributes={attributeName:"transform",type:"scale",from:"1.0",dur:"0.2s",additive:"sum",accumulate:"sum",fill:"freeze"},a&&0===m[s]?(b.options.clearAnimationTags=!1,b.attributes.to="1.25",m[s]++):a||1!==m[s]||(b.options.clearAnimationTags=!1,b.attributes.to="0.8",m[s]--),i.addAnimation(o,b)}}var i=this,j=a.selector;if(j){var l="string"==typeof a._highlight;a.info&&(i.module._data=a.info);var o,p=this.$svgcontent;if(o=p.find(j),0===o.length&&(o=p.find("#"+j)),0===o.length)return void console.warn("The svg element to modify was not found",j);if(a.innerVal&&o.html(a.innerVal),a.attributes&&!a.animation)c.any(a.attributes,function(a){return"function"==typeof a})?this.setAttributesOneByOne(o,a.attributes):o.attr(a.attributes),o.each(function(){}),i.removeStyleProperties(o,a.attributes);else if(a.animation&&!a.attributes)i.addAnimations(o,a.animation);else if(a.attributes&&a.animation&&!a.animation.attributes){a.animation.attributes=[];for(var q in a.attributes){var r={};r.attributeName=q,r.to=a.attributes[q],a.animation.attributes.push(r)}delete a.attributes,i.addAnimations(o,a.animation)}else a.attributes&&a.animation&&a.animation.attributes&&(o.attr(a.attributes),i.removeStyleProperties(o,a.attributes),i.addAnimations(o,a.animation));if(d){if(l){var s=i.getHighlightId(o);b.killHighlight(s),b.listenHighlight({_highlight:a._highlight},h,!1,s),m[s]=m[s]||0}!function(b){b.off("mouseenter.svgeditor.varout").off("mouseleave.svgeditor.varout").off("click.svgeditor.varout"),a.info&&b.on("mouseenter.svgeditor.varout",e).on("mouseleave.svgeditor.varout",f).on("click.svgeditor.varout",g);for(var c=0;c<k.length;c++)a.hasOwnProperty(k[c])&&!function(c){b.off(c),b.on(c,function(){a[c].selector||(a[c].selector=a.selector),i.modifySvgFromArray(a[c],!0)})}(k[c])}(o)}}},getHighlightId:function(a){a.map(function(){return this.getAttribute("id")}).toArray().join(",")},_clearEventCallbacks:function(a){for(var b=0;b<a.length;b++)if(a.selector)for(var c=0;c<k.length;c++)$(a.selector).off(k[c]+".svgeditor.svgmodifier")},getDom:function(){return this.dom},_loadSvg:function(){var a=this.module.getConfiguration("svgcode");this.svgCanvas.setSvgString(a),this.module.controller.onChange(a)},_saveSvg:function(){g(this)},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&c.find(this.module.getConfiguration(a),function(a){return a===b})},memorizeAnim:function(a,b){b&&a.attributes&&a.attributes.to&&a.attributes.attributeName&&(l[b]=l[b]||{},l[b][a.attributes.attributeName]=l[b][a.attributes.attributeName]||{},l[b][a.attributes.attributeName].to=a.attributes.to)},rememberAnim:function(a,b){a.attributes&&!a.attributes.from&&b&&l[b]&&l[b][a.attributes.attributeName]&&l[b][a.attributes.attributeName].to&&(a.attributes.from=l[b][a.attributes.attributeName].to)},$getAnimationTags:function(a){for(var b,c=0;c<h.length;c++)b=0===c?a.find(h[c]):b.add(a.find(h[c]));return b}}),f});