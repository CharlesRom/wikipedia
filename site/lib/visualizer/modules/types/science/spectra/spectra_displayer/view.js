define(["modules/default/defaultview","components/jsgraph/dist/jsgraph","src/util/datatraversing","src/util/api","src/util/color"],function(a,b,c,d,e){function f(){}return f.prototype=$.extend(!0,{},a,{init:function(){this.series={},this.seriesDrawn={},this.annotations={},this.dom=$("<div />"),this.zones={},this.module.getDomContent().html(this.dom),this.seriesActions=[],this.colorId=0,this.colors=["red","blue","green","black"],this.deferreds={},this.onchanges={}},inDom:function(){var a=this,c=new Promise(function(c){var d=a.module.getConfiguration.bind(a.module),e=a.module.getConfigurationCheckbox.bind(a.module),f=d("graphurl");if(f)$.getJSON(f,{},function(d){d.options.onMouseMoveData=function(b,c){a.module.controller.sendAction("mousetrack",c)},c(new b(a.dom.get(0),d.options,d.axis))});else{var g={close:{left:!1,right:!1,top:!1,bottom:!1},plugins:{},pluginAction:{}},h=d("zoom");if(h&&"none"!==h){var i={};i.zoomMode="x"===h?"x":"y"===h?"y":"xy",g.plugins["graph.plugin.zoom"]=i,g.plugins["graph.plugin.drag"]={},g.pluginAction["graph.plugin.zoom"]={shift:!1,ctrl:!1},g.pluginAction["graph.plugin.drag"]={shift:!0,ctrl:!1},g.dblclick={type:"plugin",plugin:"graph.plugin.zoom",options:{mode:"total"}}}var j=d("wheelAction");if(j&&"none"!==j){var k={baseline:d("wheelbaseline",0)};k.direction="xAxis"===j?"x":"y",g.wheel={type:"plugin",plugin:"graph.plugin.zoom",options:k}}var l=new b(a.dom.get(0),g),m={};"timestamptotime"==d("xaxismodification")?m.type="time":"valtotime"==d("xaxismodification")?m.unitModification="time":"valtotime:min.sec"==d("xaxismodification")&&(m.unitModification="time:min.sec");var n=l.getXAxis(null,m);n.flip(e("flipAxis","flipX")).togglePrimaryGrid(e("grid","vmain")).toggleSecondaryGrid(e("grid","vsec")).setLabel(d("xLabel","")).forceMin(d("minX",!1)).forceMax(d("maxX",!1)).setAxisDataSpacing(d("xLeftSpacing",0),d("xRightSpacing",0)),e("displayAxis","x")||n.hide();var o=l.getYAxis();o.flip(e("flipAxis","flipY")).togglePrimaryGrid(e("grid","hmain")).toggleSecondaryGrid(e("grid","hsec")).setLabel(d("yLabel","")).forceMin(d("minY",!1)).forceMax(d("maxY",!1)).setAxisDataSpacing(d("yBottomSpacing",0),d("yTopSpacing",0)),e("displayAxis","y")||o.hide(),e("FitYToAxisOnFromTo","rescale")&&l.getXAxis().on("zoom",function(){l.getYAxis().scaleToFitAxis(this)});var p=d("legend","none");if("none"!==p){var q,r,s,t,u=l.makeLegend({backgroundColor:"rgba( 255, 255, 255, 0.8 )",frame:!0,frameWidth:"1",frameColor:"rgba( 100, 100, 100, 0.5 )",movable:!0});switch(p){case"topright":q="right",r="top",s="max",t="max";break;case"bottomright":q="right",r="bottom",s="max",t="min";break;case"topleft":q="left",r="top",s="min",t="max";break;case"bottomleft":q="left",r="bottom",s="min",t="min"}e("flipAxis","flipX")&&(s="min"===s?"max":"min"),e("flipAxis","flipY")&&(t="min"===t?"max":"min"),u.setPosition({dx:"0px",dy:"0px",x:s,y:t},q,r)}c(l)}});c.then(function(b){a.graph=b,a.xAxis=b.getXAxis(),a.yAxis=b.getYAxis(),b.shapeHandlers.mouseOver.push(function(b){a.module.controller.createDataFromEvent("onMouseOverShape","shapeInfos",b.data),d.highlight(b.data,1)}),b.shapeHandlers.mouseOut.push(function(a){d.highlight(a.data,0)}),b.shapeHandlers.onAfterResized.push(function(b){a.module.model.dataTriggerChange(b.data)}),b.shapeHandlers.onSelected.push(function(b){a.module.model.dataTriggerChange(b.data)}),b.on("shapeSelect",function(b){a.module.controller.sendAction("selectedShape",b.data,"onShapeSelect")}),a.onResize(),a.resolveReady()})},onResize:function(){this.graph&&(this.graph.resize(this.width,this.height),this.redraw(!0))},shouldAutoscale:function(a){return this.seriesDrawn[a]?!1:(this.seriesDrawn[a]=!0,!0)},redraw:function(a,b){var c=this.module.getConfiguration("fullOut");b&&"once"===c&&(c=this.shouldAutoscale(b)?"both":"none"),a?(this.graph.redraw(),this.graph.autoscaleAxes()):"none"==c?this.graph.redraw(!0,!0):"xAxis"==c?(this.graph.redraw(!1,!0),this.xAxis.setMinMaxToFitSeries()):"yAxis"==c?(this.graph.redraw(!0,!1),this.yAxis.setMinMaxToFitSeries()):(this.graph.redraw(),this.graph.autoscaleAxes()),this.graph.drawSeries()},doZone:function(a,b,c,d){if(c&&!b[2]){var e=this.graph.makeShape({type:"rect",pos:{x:b[0]},pos2:{x:b[1]},fillColor:d,opacity:"0.5"});e.setFullHeight(),b.push(e)}else b[2]&&!c&&(b[2].kill(),b.splice(2,1))},getSerieOptions:function(a,b){var c=this,e=this.module.getConfiguration("plotinfos");b=b||[];var f={trackMouse:!0};if(e)for(var g=0,h=e.length;h>g;g++)if(a==e[g].variable){f.lineToZero=!e[g].plotcontinuous[0],f.useSlots=e[g].optimizeSlots?!!e[g].optimizeSlots[0]:!1,f.strokeWidth=parseInt(e[g].strokewidth);var i=e[g].peakpicking[0];i&&(f.autoPeakPicking=f.lineToZero?!0:"continuous")}return f.onMouseOverMarker=function(a,e,f){d.highlightId(b[a[0]],1),c.module.controller.onMouseOverMarker(f,e)},f.onMouseOutMarker=function(a,e,f){d.highlightId(b[a[0]],0),c.module.controller.onMouseOutMarker(f,e)},f},setSerieParameters:function(a,b,c){var f=this.module.getConfiguration("plotinfos");if(f)for(var g=0,h=f.length;h>g;g++)b==f[g].variable&&(a.setLineColor(e.getColor(f[g].plotcolor)),a.setLineWidth(parseFloat(f[g].strokewidth)||1),f[g].markers[0]&&a.showMarkers&&(a.showMarkers(),a.setMarkers([{type:1,zoom:2,strokeColor:e.getColor(f[g].plotcolor),fillColor:e.getColor(f[g].plotcolor),points:"all"}])),f[g].monotoneous&&f[g].monotoneous[0]&&a.XIsMonotoneous(),f[g].degrade&&a.degrade(f[g].degrade));c&&d.listenHighlight({_highlight:c},function(b,d){for(var e=0,f=d.length;f>e;e++)for(var g=Number(d[e]),h=0,i=c.length;i>h;h++){var j=c[h];(isNaN(Number(j)&&j.indexOf(g)>-1)||Number(j)===g)&&a.toggleMarker([h,0],!!b,!1)}},!1,this.module.getId())},blank:{xyArray:function(a){this.removeSerie(a)},xArray:function(a){this.removeSerie(a)},series_xy1d:function(a){this.removeSerie(a)},jcamp:function(a){this.removeSerie(a)},chart:function(a){this.removeSerie(a)},annotations:function(a){this.removeAnnotations(a)}},update:{fromTo:function(a){var b=this;a&&a.value&&b.dom.data("spectra")&&b.dom.data("spectra").setBoundaries(a.value.from,a.value.to)},chart:function(a,b){if(this.series[b]=this.series[b]||[],this.removeSerie(b),a){a=a.get();for(var c=a.data,d=0;d<c.length;d++){var e=c[d];0===d&&a.axis&&(a.axis[e.xAxis]&&this.xAxis.setLabel(a.axis[e.xAxis].name),a.axis[e.yAxis]&&this.yAxis.setLabel(a.axis[e.yAxis].name));var f=c.serieLabel,g=[];switch(e.serieType){case"zone":if(e.yMin&&e.yMax)for(var h=0,i=e.yMax.length;i>h;h++)g.push(e.x?e.x[h]:h),g.push(e.yMin[h],e.yMax[h]);break;default:if(e.y)for(var h=0,i=e.y.length;i>h;h++)g.push(e.x?e.x[h]:h),g.push(e.y[h])}var j=this.graph.newSerie(f,this.getSerieOptions(b,e._highlight),e.serieType||void 0);this.normalize(g,b),j.setData(g),e.info&&(j.infos=e.info),j.autoAxis(),"scatter"!=String(e.serieType)&&this.setSerieParameters(j,b,e._highlight),this.series[b].push(j)}this.redraw(!1,b)}},xyArray:function(a,b){if(this.series[b]=this.series[b]||[],this.removeSerie(b),a){var c=a.get(),d=this.graph.newSerie(b,this.getSerieOptions(b));this.normalize(c,b),d.setData(c),d.autoAxis(),this.setSerieParameters(d,b),this.series[b].push(d),this.redraw(!1,b)}},xArray:function(a,b){var c=a.get();this.series[b]=this.series[b]||[],this.removeSerie(b);for(var d=this.graph.newSerie(b,this.getSerieOptions(b)),e=this.module.getConfiguration("minX",0),f=this.module.getConfiguration("maxX",c.length-1),g=(f-e)/(c.length-1),h=[],i=0,j=c.length;j>i;i++)h.push(e+g*i),h.push(c[i]);this.normalize(h,b),d.setData(h),d.autoAxis(),this.setSerieParameters(d,b),this.series[b].push(d),this.redraw(!1,b)},annotations:function(a,b){d.killHighlight(this.module.getId()),this.annotations[b]=this.annotations[b]||[],this.removeAnnotations(b);for(var c=a.get(),e=0,f=c.length,g=this;f>e;e++)!function(a){var e=c[a],f=g.graph.newShape(e,null,null,!0);g.annotations[b][a]=f,f.setSerie(g.graph.getSerie(0)),d.listenHighlight(e,function(a){a?f.highlight({fill:"black"}):f.unHighlight()},!1,g.module.getId()),g.module.model.dataListenChange(c.traceSync([a]),function(){f.redraw()},"annotations"),f.draw(),f.redraw()}(e)},jcamp:function(a,b){if(a){a=String(a.get());var c,e=this;if(d.killHighlight(this.module.getId()+b),this.graph){this.zones[b]=a._zones,e.deferreds[b]&&e.deferreds[b].reject(),e.deferreds[b]=$.Deferred();var f=e.deferreds[b];require(["components/jcampconverter/build/jcampconverter"],function(g){g.convert(a,{lowRes:1024},!0).then(function(g){if("rejected"!=f.state()){if(e.deferreds[b]=!1,e.series[b]=e.series[b]||[],e.series[b]=[],g.contourLines)c=e.graph.newSerie(b,e.getSerieOptions(b),"contour"),c.setData(g.contourLines),c.autoAxis(),e.setSerieParameters(c,b),e.series[b].push(c);else{g=g.spectra;for(var h=0,i=g.length;i>h;h++){c=e.graph.newSerie(b,e.getSerieOptions(b));var j=g[h].data[g[h].data.length-1];e.normalize(j,b),c.setData(j),c.autoAxis(),e.setSerieParameters(c,b),e.series[b].push(c);break}d.listenHighlight(a._highlight||[],function(a,c){for(var d=0;d<c.length;d++)e.zones[b][c[d]]&&e.doZone(b,e.zones[b][c[d]],a,e.series[b].options.lineColor)},!0,e.module.getId()+b)}e.redraw(!1,b)}})})}}},series_xy1d:function(a,b){var c=this;require(["src/util/color"],function(d){for(var e=d.getDistinctColors(a.length),f=0,g=a.length;g>f;f++){var h=c.getSerieOptions(b),i=c.graph.newSerie(a[f].name,h);i.autoAxis(),c.series[b].push(i),a[f].data?i.setData(a[f].data):console.log(a[f].data),i.setLineWidth(a[f].lineWidth||h.strokeWidth||1),i.setLineColor(a[f].lineColor||"rgb("+e[f].join()+")"),i.setLineWidth(3,"selected")}c.redraw()})}},setOnChange:function(a,b,c){this.onchanges[b]&&this.onchanges[b].obj.unbindChange(this.onchanges[b].id),this.onchanges[b]={obj:c,id:a}},removeAnnotations:function(a){if(this.annotations[a])for(var b=0;b<this.annotations[a].length;b++)this.annotations[a][b].kill();this.annotations[a]=[]},removeSerie:function(a){if(this.series[a])for(var b=0;b<this.series[a].length;b++)this.series[a][b].kill(!0);this.series[a]=[]},makeSerie:function(a,b,c){var d=this,e=this.graph.newSerie(a.name);a.onChange(function(){e.setData(a.data),d.graph.redraw(),d.graph.drawSeries()}),this.onActionReceive.removeSerieByName.call(this,a.name||{}),e.autoAxis(),e.setData(a.data),this.seriesActions.push([b,e,a.name]),this.setSerieParameters(e,c),a.lineColor&&e.setLineColor(a.lineColor),a.lineWidth&&e.setLineWidth(a.lineWidth),this.redraw()},onActionReceive:{fromTo:function(a){a=a.get(),this.graph.getBottomAxis()._doZoomVal(a.from,a.to,!0),this.graph.redraw(!0),this.graph.drawSeries()},addSerie:function(a){if(this.colorId++,a=a.get(),a.name)this.makeSerie(a,a,a.name);else for(var b in a)this.makeSerie(a[b],a)},removeSerie:function(a){a=a.get();for(var b=0,c=this.seriesActions.length;c>b;b++)this.seriesActions[b][0]==a&&(this.seriesActions[b][1].kill(),this.seriesActions.splice(b,1))},removeSerieByName:function(a){for(var b=0;b<this.seriesActions.length;b++)this.seriesActions[b][2]==a&&(this.seriesActions[b][1].kill(),this.seriesActions.splice(b,1),b--)},selectSerie:function(a){var b=this.graph.getSerie(a);b&&b.select("selected")},unselectSerie:function(a){var b=this.graph.getSerie(a);b&&b.unselect()}},getDom:function(){return this.dom},normalize:function(a,b){var c,d,e,f,g,h,i=this.module.getConfiguration("plotinfos");if(i){var j="";for(g=0,h=i.length;h>g;g++)b==i[g].variable&&(j=i[g].normalize);if(j)if(Array.isArray(a[0])){if("max1"==j){for(c=-1/0,g=0;g<a.length;g++)a[g][1]>c&&(c=a[g][1]);for(g=0;g<a.length;g++)a[g][1]/=c}else if("sum1"==j){for(e=0,g=0;g<a.length;g++)e+=a[g][1];for(g=0;g<a.length;g++)a[g][1]/=e}else if("max1min0"==j){for(c=-1/0,d=1/0,g=0;g<a.length;g++)a[g][1]>c&&(c=a[g][1]),a[g][1]<d&&(d=a[g][1]);for(f=1/(c-d),g=0;g<a.length;g++)a[g][1]=(a[g][1]-d)*f}}else if("max1"==j){for(c=-1/0,g=1;g<a.length;g+=2)a[g]>c&&(c=a[g]);for(g=1;g<a.length;g+=2)a[g]/=c}else if("sum1"==j){for(e=0,g=1;g<a.length;g+=2)e+=a[g];for(g=1;g<a.length;g+=2)a[g]/=e}else if("max1min0"==j){for(c=-1/0,d=1/0,g=1;g<a.length;g+=2)a[g]>c&&(c=a[g]),a[g]<d&&(d=a[g]);for(f=1/(c-d),g=1;g<a.length;g+=2)a[g]=(a[g]-d)*f}}}}),f});